@page "/check-email"
@layout LoginLayout
@using Programming_Examination_Platform.Model
@using Microsoft.EntityFrameworkCore
@using System.Security.Cryptography
@using System.Text
@using System.Net.Mail
@using System.Net
@using Programming_Examination_Platform.Services
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject StudentService StudentService
@inject JavaExamContext DbContext
@inject IDialogService DialogService

<br /><br />
<br />
<style>
    body {
        background: rgb(255,255,255);
        background: radial-gradient(circle, rgba(89,74,226,1) 0%, rgba(0,32,96,0.22172619047619047) 100%);
    }

    .center {
        margin: auto;
        width: 80%;
        padding: 20px;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 1000;
    }

    .custom-card {
        width: 100%;
        max-width: 800px;
        padding: 10px;
    }

    .custom-card-content {
        padding: 20px;
    }

    .svg-icon {
        width: 25px;
        height: 25px;
    }

    .blur-overlay {
        filter: blur(2px);
        pointer-events: none;
    }
</style>

<div class="@(_isPageBlurred ? "blur-overlay" : "")">
    <MudAppBar Color="Color.Primary" Fixed="true" Elevation="0">
        <div style="padding: 10px; display: flex; align-items: center;">
            <img src="images/header.png" style="max-height: 50px; max-width: 201px;" />
        </div>
    </MudAppBar>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <MudStack Spacing="15" Row="true" Justify="Justify.Center">
        <MudSpacer/>
        <MudCard Class="custom-card">
            <MudCardMedia Image="images/registerBanner.png" Height="200" />
            <MudCardContent Class="custom-card-content">
               <MudText Typo="Typo.h4">We first want to make sure it's you!</MudText>
                <MudText Typo="Typo.h6">Enter the 6-digit code sent to @Email</MudText>
                <br/>
               <MudTextField T="string" Label="Verification Code" @bind-Value="_value" MaxLength="6" />
               <br/><br/>
                <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.RestartAlt" FullWidth="true" Color="Color.Primary" OnClick="ResendCode" Disabled="@_isResendDisabled">Resend Code</MudButton>
                <br/><br/>
               <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.CheckCircle" FullWidth="true" Color="Color.Primary" OnClick="VerifyCode">Verify</MudButton>
            </MudCardContent>
        </MudCard>
        <MudSpacer/>
    </MudStack>
</div>
<br />
<br />
<br />

@code {
    private string _value;
    private bool _isResendDisabled;
    private string Email { get; set; }
    private bool _isPageBlurred = false;
    private bool hasPassword = false;
    private Model.Studenti? _Student;
    private int _UserID;
    private string _message = "";  // Variable to hold messages to display
    private int _alert;
    
    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        Email = await LocalStorage.GetItemAsync<string>("userEmail");
        _UserID = await LocalStorage.GetItemAsync<int>("userID");
        _Student = await StudentService.GetStudentById(_UserID);
        hasPassword = (_Student.Passkey == 1 ? false : true);
    }
    private void OpenPasswordVerificationDialog()
    {
        var options = new DialogOptions
        {
            DisableBackdropClick = true, // Makes the dialog non-closable by clicking outside
            FullWidth = true, // Ensures the dialog is full width
            CloseButton = false, // Hides the close button
            MaxWidth = MaxWidth.Small // Sets the dialog's max width to small
        };

        DialogService.Show<DialogPassword>("Verify Your Password", options);
    }
    
    private async System.Threading.Tasks.Task VerifyCode()
    {
        var storedCode = await LocalStorage.GetItemAsync<string>("verificationCode");

        if (_value == storedCode)
        {
            _isPageBlurred = true; // Blur the page
            Snackbar.Add("Verification successful!", Severity.Success);

            if (hasPassword)
            {
                OpenPasswordVerificationDialog();
            }
            else
            {
                // Register Passkey or other next steps
                await CheckPasskey();
            }
        }
        else
        {
            Snackbar.Add("Incorrect verification code.", Severity.Error);
        }
    }

    private async System.Threading.Tasks.Task CheckPasskey()
    {
        try
        {
            var assertion = await JSRuntime.InvokeAsync<object>("getAssertion");

    // Extract the email from the assertion and verify it
            var userEmail = await LocalStorage.GetItemAsync<string>("userEmail");
            if (string.IsNullOrEmpty(userEmail))
            {
                Snackbar.Add("No passkey registered for this device.", Severity.Error);
                return;
            }
            if (userEmail != _Student.Email)
            {
                Snackbar.Add("You've checked in with a different email than the logged in one.", Severity.Error);
                return;
            }

            var student = await DbContext.Studentis.AsNoTracking().FirstOrDefaultAsync(s => s.Email == userEmail);
            if (student != null)
            {
                _message = "Successfully verified with Passkey!";
                _alert = 0;
                NavigationManager.NavigateTo("/edit-profile"); ///DO NOT FORGET TO PUT THE PAGE HERE
            }
            else
            {
                Snackbar.Add("No account associated with this passkey email.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
    }

    private async System.Threading.Tasks.Task ResendCode()
    {
        _isResendDisabled = true;

        string verificationCode = GenerateVerificationCode();
        await LocalStorage.SetItemAsync("verificationCode", verificationCode);
        await SendVerificationCodeEmail(Email, verificationCode);

        Snackbar.Add("A new verification code has been sent.", Severity.Info);

        await System.Threading.Tasks.Task.Delay(20000);
        _isResendDisabled = false;
    }

    private string GenerateVerificationCode()
    {
        var random = new Random();
        return random.Next(100000, 999999).ToString();
    }

    public async System.Threading.Tasks.Task SendVerificationCodeEmail(string email, string code)
    {
        try
        {
            var fromAddress = new MailAddress("java.exam@infinity-atom.ro", "Programming Examination Platform");
            var toAddress = new MailAddress(email);
            string subject = "Your Verification Code";
            string headerImageBase64 = Convert.ToBase64String(System.IO.File.ReadAllBytes("wwwroot/images/header.png"));
            string headerImageSrc = $"data:image/png;base64,{headerImageBase64}";

            string body = $@"
<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <style>
        body {{
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }}
        .container {{
            max-width: 600px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px;
            border: 1px solid #dddddd;
            border-radius: 5px;
        }}
        .header {{
            background-color: rgba(89,74,226,1);
            padding: 10px;
            text-align: center;
            color: white;
        }}
        .header img {{
            max-width: 320px;
            height: auto;
        }}
        .content {{
            padding: 20px;
            line-height: 1.6;
        }}
        .content h1 {{
            color: #333333;
        }}
        .content p {{
            color: #666666;
        }}
        .code-box {{
            background-color: #f9f9f9;
            padding: 15px;
            border: 1px solid #dddddd;
            border-radius: 5px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 5px;
            color: #333333;
        }}
        .footer {{
            background-color: #333333;
            padding: 10px;
            text-align: center;
            color: white;
            font-size: 12px;
        }}
        .footer a {{
            color: #ffffff;
            text-decoration: none;
        }}
        .footer a:hover {{
            text-decoration: underline;
        }}
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <img src='{headerImageSrc}' alt='Company Logo'>
        </div>
        <div class='content'>
            <h1>Account Edit</h1>
            <p>Hello,</p>
            <p>We want to make sure that the person that is trying to edit data in your account is really you. Enter the code below in the box to continue:</p>
            <div class='code-box'>{code}</div>
            <p>This code will expire in 10 minutes.</p>
            <p>If you did not request this code, please<b> DELETE </b>this email.</p>
        </div>
        <div class='footer'>
            <p>&copy; 2024 Infinity Atom. All rights reserved.</p>
            <p><a href='#'>Privacy Policy</a> | <a href='#'>Terms of Service</a></p>
        </div>
    </div>
</body>
</html>";

            var smtp = new SmtpClient
            {
                Host = "mail.infinity-atom.ro",
                Port = 587,
                EnableSsl = true,
                DeliveryMethod = SmtpDeliveryMethod.Network,
                UseDefaultCredentials = false,
                Credentials = new NetworkCredential(fromAddress.Address, "p@SSWORD20caractereabc1")
            };

            using (var message = new MailMessage(fromAddress, toAddress))
            {
                message.Subject = subject;
                message.Body = body;
                message.IsBodyHtml = true;
                await smtp.SendMailAsync(message);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Snackbar.Add($"An error occurred while sending the email: {ex.Message}", Severity.Error);
        }
    }
}
